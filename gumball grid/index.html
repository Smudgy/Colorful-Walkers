<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <style>
  canvas {
    position: absolute;
    top: 0;
    left: 0;
  }

  </style>

</head>

<body>
  <script src="p5.js"></script>
  <script>
  //onload + audiolistener function

  window.wallpaperPropertyListener = {
    applyUserProperties: function(properties) {
      if (properties.amount) {
        n = properties.amount.value;
        // clear the grid and make a new one
        dots = [];
        setup();
      }
      if (properties.hex) {
        if ( properties.hex.value ) {
          swtch = w/(4*n);
        } else {
          swtch = 0;
        }
        // clear the grid and make a new one
        dots = [];
        setup();
      }

      if (properties.sh1) {
        sh1 = properties.sh1.value;
        // clear the grid and make a new one
        dots = [];
        setup();
      }
      if (properties.sh2) {
        sh2 = properties.sh2.value;
        // clear the grid and make a new one
        dots = [];
        setup();
      }
      if (properties.shd) {
        shd = properties.shd.value;
      }
      if (properties.shp) {
        shp = 5.0 / ( 10.0 / ( properties.shp.value + 6 ));
      }

      if (properties.rad1) {
        rad1 = properties.rad1.value;
      }
      if (properties.rad2) {
        rad2 = properties.rad2.value;
      }
      if (properties.radd) {
        radd = properties.radd.value;
      }
      if (properties.radp) {
        radp = 5.0 / ( 10.0 / ( properties.radp.value + 6 ));
      }

      if (properties.rou1) {
        rou1 = properties.rou1.value;
      }
      if (properties.rou2) {
        rou2 = properties.rou2.value;
      }
      if (properties.roud) {
        roud = properties.roud.value;
      }
      if (properties.roup) {
        roup = 5.0 / ( 10.0 / ( properties.roup.value + 6 ));
      }

      if (properties.hue1) {
        hue1 = properties.hue1.value;
      }
      if (properties.hue2) {
        hue2 = properties.hue2.value;
      }
      if (properties.hued) {
        hued = properties.hued.value;
      }
      if (properties.huep) {
        huep = 5.0 / ( 10.0 / ( properties.huep.value + 6 ));
      }
      if (properties.hueLoop) {
        hueLoop = properties.hueLoop.value / 10.0;
      }

      if (properties.sat1) {
        sat1 = properties.sat1.value;
      }
      if (properties.sat2) {
        sat2 = properties.sat2.value;
      }
      if (properties.satd) {
        satd = properties.satd.value;
      }
      if (properties.satp) {
        satp = 5.0 / ( 10.0 / ( properties.satp.value + 6 ));
      }

      if (properties.lum1) {
        lum1 = properties.lum1.value;
      }
      if (properties.lum2) {
        lum2 = properties.lum2.value;
      }
      if (properties.lumd) {
        lumd = properties.lumd.value;
      }
      if (properties.lump) {
        lump = 5.0 / ( 10.0 / ( properties.lump.value + 6 ));
      }

      if (properties.a1) {
        a1 = properties.a1.value / 100.0;
      }
      if (properties.a2) {
        a2 = properties.a2.value / 100.0;
      }
      if (properties.ad) {
        ad = properties.ad.value;
      }
      if (properties.ap) {
        ap = 5.0 / ( 10.0 / ( properties.ap.value + 6 ));
      }

      if (properties.rot1) {
        rot2 = properties.rot1.value;
      }
      if (properties.rot2) {
        rot2 = properties.rot2.value;
      }
      if (properties.rotd) {
        rotd = properties.rotd.value;
      }
      if (properties.rotp) {
        rotp = 5.0 / ( 10.0 / ( properties.rotp.value + 6 ));
      }
      if (properties.rotLoop) {
        rotLoop = properties.rotLoop.value / 10.0;
      }
    }
  };

  // -----------------------------------------------------
  // global variables

  let w = window.innerWidth;
  let h = window.innerHeight;
  let dots = [];

  // customizable variables

  // radius ( 0 - inf )
  let rad1 = 25;
  let rad2 = -20;
  let radd = 500;
  let radp = 5;

  // shift ( 0 - inf )
  let sh1 = 20;
  let sh2 = 50;
  let shd = 500;
  let shp = 2;

  // roundoff ( 0 - 100% )
  let rou1 = 20;
  let rou2 = 80;
  let roud = 500;
  let roup = 2;

  // hue ( 0 - 360 )
  let hue1 = 120;
  let hue2 = 0;
  let hued = 1000;
  let huep = 1;
  let hueLoop = 0;

  // sat ( 0 - 100 )
  let sat1 = 0;
  let sat2 = 100;
  let satd = 500;
  let satp = 1;

  // lum ( 0 - 100 )
  let lum1 = 30;
  let lum2 = 20;
  let lumd = 500;
  let lump = 1;

  // alpha ( 0 - 100 )
  let a1 = 1;
  let a2 = 1;
  let ad = 500;
  let ap = 5;

  // rotation ( 0 - inf )
  let rot1 = 90;
  let rot2 = 360;
  let rotd = 500;
  let rotp = 1;
  let rotLoop = 75;

  let n = 25;
  let swtch = w/(4*n);

  // Dot class

  class Dot {
    constructor(x, y) {
      this.v1 = createVector(x,y);
    }

    show() {
      //let d = dist(this.v1.x, this.v1.y, mouseX, mouseY);
      let v2 = createVector(mouseX - this.v1.x, mouseY - this.v1.y);
      let d = v2.mag();
      v2.normalize();

      let shift = sh1 + sh2 * pow(map(d, 0, shd, 1.0, 0, true), shp);
      let rotation = rot1 + rotLoop * frameCount + rot2 * pow(map(d, 0, rotd, 1.0, 0, true), rotp);

      let hue = ( hue1 + hueLoop * frameCount + hue2 * pow(map(d, 0, hued, 1.0, 0, true), huep)) % 360;
      let sat = sat1 + sat2 * pow(map(d, 0, satd, 1.0, 0, true), satp );
      let lum = lum1 + lum2 * pow(map(d, 0, lumd, 1.0, 0, true), lump );
      let alpha = a1 + a2 * pow(map(d, 0, ad, 1.0, 0, true), ap);

      let radius = Math.max( rad1 + rad2 * pow(map(d, 0, radd, 1.0, 0, true), radp), 0 );
      let roundoff = Math.max( ( rou1 + rou2 * pow(map(d, 0, roud, 1.0, 0, true), roup)) * radius / 200, 0 );

      noStroke();

      push();
      colorMode(HSB);
      translate(this.v1.x - shift * v2.x, this.v1.y - shift * v2.y);
      rotate( rotation );
      fill( hue, sat, lum, alpha );
      rect(0, 0, radius, radius, roundoff);
      pop();
    }
  };

  // p5 setup() and draw()

  function setup() {
    createCanvas(w, h);
    angleMode(DEGREES);
    rectMode(CENTER);

    bound = Math.abs(sh1) + Math.abs(sh2);

    for (let y = -bound; y < h + bound; y += w/n) {
      for (let x = -swtch - bound; x < w - swtch + bound; x += w/n) {
        dots.push(new Dot(x, y));
      }
      swtch *= -1;
    }
  }

  function draw() {
    push();
    colorMode(HSB);
    background(200, 30, 10);
    pop();

    for (let i = 0; i < dots.length; i++) {
      dots[i].show();
    }
  }

  // resize function

  window.addEventListener('resize', function() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
  })

  </script>
</body>

</html>
